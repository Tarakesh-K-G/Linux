# gnomAD
wget https://storage.googleapis.com/gcp-public-data--broad-references/hg38/v0/somatic-hg38/af-only-gnomad.hg38.vcf.gz ~/home/tarak/somatic_mutect2/mutect2_supporting_files
wget https://storage.googleapis.com/gcp-public-data--broad-references/hg38/v0/somatic-hg38/af-only-gnomad.hg38.vcf.gz.tbi ~/home/tarak/somatic_mutect2/mutect2_supporting_files

# PoN
wget https://storage.googleapis.com/gatk-best-practices/somatic-hg38/1000g_pon.hg38.vcf.gz ~/home/tarak/somatic_mutect2/mutect2_supporting_files
wget https://storage.googleapis.com/gatk-best-practices/somatic-hg38/1000g_pon.hg38.vcf.gz.tbi ~/home/tarak/somatic_mutect2/mutect2_supporting_files

# to create your own panel of normals: https://gatk.broadinstitute.org/hc/en-us/articles/360037058172-CreateSomaticPanelOfNormals-BETA

# intervals list
wget https://storage.googleapis.com/gcp-public-data--broad-references/hg38/v0/exome_calling_regions.v1.1.interval_list ~/home/tarak/somatic_mutect2/mutect2_supporting_files

# STEP 1: QC - Run fastqc
sudo apt install fastqc
#Normal
fastqc /home/tarak/somatic_mutect2/reads/PA221MH-lib09-P19-Norm_S1_L001_R1_001.fastq.gz -o /home/tarak/somatic_mutect2/reads/
fastqc /home/tarak/somatic_mutect2/reads/PA221MH-lib09-P19-Norm_S1_L001_R2_001.fastq.gz -o /home/tarak/somatic_mutect2/reads/
#Tumor
fastqc /home/tarak/somatic_mutect2/reads/PA220KH-lib09-P19-Tumor_S2_L001_R1_001.fastq.gz -o /home/tarak/somatic_mutect2/reads/
fastqc /home/tarak/somatic_mutect2/reads/PA220KH-lib09-P19-Tumor_S2_L001_R2_001.fastq.gz -o /home/tarak/somatic_mutect2/reads/

# Trimming (If there is any adopter or low quality shown in fastqc file)
sudo apt install fastp
#Tumor
fatsp -i /home/tarak/somatic_mutect2/reads/PA220KH-lib09-P19-Tumor_S2_L001_R1_001.fastq.gz\
-I /home/tarak/somatic_mutect2/reads/PA220KH-lib09-P19-Tumor_S2_L001_R2_001.fastq.gz\
-o /home/tarak/somatic_mutect2/reads/PA220KH-lib09-P19-Tumor_S2_L001_R1_001.trimmed.fastq.gz\
-O /home/tarak/somatic_mutect2/reads/PA220KH-lib09-P19-Tumor_S2_L001_R2_001.trimmed.fastq.gz\
-h /home/tarak/somatic_mutect2/reads/fastp_report.html\
-j /home/tarak/somatic_mutect2/reads/fastp_report.jsom\
-W 4

#Normal
fatsp -i /home/tarak/somatic_mutect2/reads/PA221MH-lib09-P19-Norm_S1_L001_R1_001.fastq.gz\
-I /home/tarak/somatic_mutect2/reads/PA221MH-lib09-P19-Norm_S1_L001_R2_001.fastq.gz\
-o /home/tarak/somatic_mutect2/reads/PA221MH-lib09-P19-Norm_S1_L001_R1_001.trimmed.fastq.gz\
-O /home/tarak/somatic_mutect2/reads/PA221MH-lib09-P19-Norm_S1_L001_R2_001.trimmed.fastq.gz\
-h /home/tarak/somatic_mutect2/reads/fastp_report.html\
-j /home/tarak/somatic_mutect2/reads/fastp_report.jsom\
-W 4

#STEP 2: Map to reference using BWA-MEM
# BWA index reference 
bwa index /home/tarak/reference/hg38/hg38.fa

#BWA alignment
#Tumor
bwa mem -R "@RG\tID:PA220KH-T\tSM:PA221MH\tPL:ILLUMINA\tLB:lib09" /home/tarak/reference/hg38/hg38.fa /home/tarak/somatic_mutect2/reads/PA220KH-lib09-P19-Tumor_S2_L001_R1_001.trimmed.fastq.gz /home/tarak/somatic_mutect2/reads/PA220KH-lib09-P19-Tumor_S2_L001_R2_001.trimmed.fastq.gz > /home/tarak/somatic_mutect2/aligned_reads/PA220KH_Tumor.aligned.sam

#Normal
bwa mem -R "@RG\tID:PA220KH-N\tSM:PA221MH\tPL:ILLUMINA\tLB:lib09" /home/tarak/reference/hg38/hg38.fa /home/tarak/somatic_mutect2/reads/PA221MH-lib09-P19-Norm_S1_L001_R1_001.trimmed.fastq.gz /home/tarak/somatic_mutect2/reads/PA221MH-lib09-P19-Norm_S1_L001_R2_001.trimmed.fastq.gz > /home/tarak/somatic_mutect2/aligned_reads/PA220KH_Normal.aligned.sam

# STEP 3: Mark Duplicates and Sort - GATK4
./gatk MarkDuplicatesSpark -I /home/tarak/somatic_mutect2/aligned_reads/PA220KH_Tumor.aligned.sam -O /home/tarak/somatic_mutect2/aligned_reads/PA220KH_Tumor_sorted_dedup_reads.bam
./gatk MarkDuplicatesSpark -I /home/tarak/somatic_mutect2/aligned_reads/PA220KH_Normal.aligned.sam -O /home/tarak/somatic_mutect2/aligned_reads/PA220KH_Normal_sorted_dedup_reads.bam

# STEP 4: Base quality recalibration
# 1. build the model
./gatk BaseRecalibrator -I /home/tarak/somatic_mutect2/aligned_reads/PA220KH_Tumor_sorted_dedup_reads.bam -R /home/tarak/reference/hg38/hg38.fa --known-sites /home/tarak/reference/hg38/Homo_sapiens_assembly38.dbsnp138.vcf -O /home/tarak/somatic_mutect2/data/Tumor_recal_data.table
./gatk BaseRecalibrator -I /home/tarak/somatic_mutect2/aligned_reads/PA220KH_Normal_sorted_dedup_reads.bam -R /home/tarak/reference/hg38/hg38.fa --known-sites /home/tarak/reference/hg38/Homo_sapiens_assembly38.dbsnp138.vcf -O /home/tarak/somatic_mutect2/data/Normal_recal_data.table

# 2. Apply the model to adjust the base quality scores
./gatk ApplyBQSR -I /home/tarak/somatic_mutect2/aligned_reads/PA220KH_Tumor_sorted_dedup_reads.bam -R /home/tarak/reference/hg38/hg38.fa --bqsr-recal-file /home/tarak/somatic_mutect2/data/Tumor_recal_data.table -O /home/tarak/somatic_mutect2/aligned_reads/PA220KH_Tumor_sorted_bqsr_reads.bam 
./gatk ApplyBQSR -I /home/tarak/somatic_mutect2/aligned_reads/PA220KH_Normal_sorted_dedup_reads.bam -R /home/tarak/reference/hg38/hg38.fa --bqsr-recal-file /home/tarak/somatic_mutect2/data/Normal_recal_data.table -O /home/tarak/somatic_mutect2/aligned_reads/PA220KH_Normal_sorted_bqsr_reads.bam 

# STEP 5: Collect Alignment & Insert Size Metrics
./gatk CollectAlignmentSummaryMetrics R=/home/tarak/reference/hg38/hg38.fa I=/home/tarak/somatic_mutect2/aligned_reads/PA220KH_Tumor_sorted_bqsr_reads.bam O=/home/tarak/somatic_mutect2/aligned/Tumor_alignment_metrics.txt
./gatk CollectInsertSizeMetrics INPUT=/home/tarak/somatic_mutect2/aligned_reads/PA220KH_Tumor_sorted_bqsr_reads.bam OUTPUT=/home/tarak/somatic_mutect2/aligned_reads/Tumor_insert_size_metrics.txt HISTOGRAM_FILE=/home/tarak/somatic_mutect2/aligned_reads/Tumor_insert_size_histogram.pdf

./gatk CollectAlignmentSummaryMetrics R=/home/tarak/reference/hg38/hg38.fa I=/home/tarak/somatic_mutect2/aligned_reads/PA220KH_Normal_sorted_bqsr_reads.bam O=/home/tarak/somatic_mutect2/aligned_reads/Normal_alignment_metrics.txt
./gatk CollectInsertSizeMetrics INPUT=/home/tarak/somatic_mutect2/aligned_reads/PA220KH_Normal_sorted_bqsr_reads.bam OUTPUT=/home/tarak/somatic_mutect2/aligned_reads/Normal_insert_size_metrics.txt HISTOGRAM_FILE=/home/tarak/somatic_mutect2/aligned_reads/Normal_insert_size_histogram.pdf

#STEP 6: Call Variants - gatk mutect2 caller
./gatk Mutect2 -R /home/tarak/reference/hg38/hg38.fa \
     -I /home/tarak/somatic_mutect2/aligned_reads/PA220KH_Tumor_sorted_bqsr_reads.bam \
     -I /home/tarak/somatic_mutect2/aligned_reads/PA220KH_Normal_sorted_bqsr_reads.bam \
     -tumor PA220KH-T \
     -normal PA220KH-N \
     --germline-resource /home/tarak/somatic_mutect2/mutect2_supporting_files/af-only-gnomad.hg38.vcf.gz \
     --panel-of-normals /home/tarak/somatic_mutect2/mutect2_supporting_files/1000g_pon.hg38.vcf.gz \
     -O /home/tarak/somatic_mutect2/results/PA220KH_somatic_variants_mutect2.vcf.gz \
     --f1r2-tar-gz /home/tarak/somatic_mutect2/results/PA220KH_f1r2.tar.gz \

#STEP 7: Estimate cross-sample contamination
# tumor
./gatk GetPileupSummaries \
    --java-options '-Xmx50G' --tmp-dir /home/tarak/somatic_mutect2/tmp/ \
    -I /home/tarak/somatic_mutect2/aligned_reads/PA220KH_Tumor_sorted_bqsr_reads.bam \
    -V /home/tarak/somatic_mutect2/mutect2_supporting_files/af-only-gnomad.hg38.vcf.gz \
    -L /home/tarak/somatic_mutect2/mutect2_supporting_files/exome_calling_regions.v1.1.interval_list \
    -O /home/tarak/somatic_mutect2/results/PA220KH_Tumor_getpileupsummaries.table

# normal
./gatk GetPileupSummaries \
    --java-options '-Xmx50G' --tmp-dir /home/tarak/somatic_mutect2/tmp/ \
    -I /home/tarak/somatic_mutect2/aligned_reads/PA220KH_Normal_sorted_bqsr_reads.bam  \
    -V /home/tarak/somatic_mutect2/mutect2_supporting_files/af-only-gnomad.hg38.vcf.gz \
    -L /home/tarak/somatic_mutect2/mutect2_supporting_files/exome_calling_regions.v1.1.interval_list \
    -O /home/tarak/somatic_mutect2/results/PA220KH_Normal_getpileupsummaries.table

# Calculate contamination
./gatk CalculateContamination \
    -I /home/tarak/somatic_mutect2/results/PA220KH_Tumor_getpileupsummaries.table \
    -matched /home/tarak/somatic_mutect2/results/PA220KH_Normal_getpileupsummaries.table \
    -O /home/tarak/somatic_mutect2/results/PA220KH_pair_calculatecontamination.table 

#STEP 8: Estimate read orientation artifacts
# read orientation
./gatk LearnReadOrientationModel \
    -I /home/tarak/somatic_mutect2/results/PA220KH_f1r2.tar.gz \
    -O /home/tarak/somatic_mutect2/results/read-orientation-model.tar.gz

#STEP 9: Filter Variants
./gatk FilterMutectCalls \
        -V /home/tarak/somatic_mutect2/results/PA220KH_somatic_variants_mutect2.vcf.gz \
        -R /home/tarak/reference/hg38/hg38.fa \
        --contamination-table /home/tarak/somatic_mutect2/results/PA220KH_pair_calculatecontamination.table \
        --ob-priors /home/tarak/somatic_mutect2/results/read-orientation-model.tar.gz \
        -O /home/tarak/somatic_mutect2/results/PA220KH_somatic_variants_filtered_mutect2.vcf

#STEP 10: Annotate using Funcotator
./gatk Funcotator \
    --variant /home/tarak/somatic_mutect2/results/PA220KH_somatic_variants_filtered_mutect2.vcf \
    --reference /home/tarak/reference/hg38/hg38.fa \
    --ref-version hg38 \
    --data-sources-path /home/tarak/demo/tools/functotator_prepackaged_sources/funcotator/hg38/funcotator_dataSources.v1.8.hg38.20230908s \
    --output /home/tarak/somatic_mutect2/results/PA220KH_somatic_variants_functotated.vcf \
    --output-file-format VCF
